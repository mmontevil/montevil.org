// mathjaxTransform.js â€” MathJax 4, Eleventy, ESM, server-side

import { mathjax } from '@mathjax/src/js/mathjax.js';
import { MathML } from '@mathjax/src/js/input/mathml.js';
import { CHTML } from '@mathjax/src/js/output/chtml.js';

import { liteAdaptor } from '@mathjax/src/js/adaptors/liteAdaptor.js';
import { RegisterHTMLHandler } from '@mathjax/src/js/handlers/html.js';
import { AssistiveMmlHandler } from '@mathjax/src/js/a11y/assistive-mml.js';

import '@mathjax/src/js/util/entities/all.js';
import { DOMParser } from 'linkedom';
import CleanCSS from 'clean-css';

/* ------------------------------------------------------------------ */
/* REQUIRED for MathJax 4 server-side dynamic loading                  */
/* ------------------------------------------------------------------ */
mathjax.asyncLoad = async (modulePath) => import(modulePath);

/* ------------------------------------------------------------------ */
/* Main Eleventy Transform                                              */
/* ------------------------------------------------------------------ */
export default async function mathjaxTransform(content, outputPath) {
  // Only transform HTML files in your publications/articles
  if (
    !outputPath ||
    !outputPath.endsWith('.html') ||
    !outputPath.includes('publications') ||
    !(outputPath.includes('articles') || outputPath.includes('chapters')) ||
    !content.includes('<!--CompileMaths-->')
  ) {
    return content;
  }

  // ------------------------------------------------------------------
  // Lite adaptor + handler
  // ------------------------------------------------------------------
  const adaptor = liteAdaptor({ fontSize: 16 });
  AssistiveMmlHandler(RegisterHTMLHandler(adaptor));

  // ------------------------------------------------------------------
  // Input / Output Jax
  // ------------------------------------------------------------------
  const mathml = new MathML();
  const chtml = new CHTML({
    fontURL: '/assets/fonts/woff-2', // STIX Two fonts
    exFactor: 8 / 16,
    scale: 1,
    displayAlign: 'center',
    displayIndent: '0',
    adaptiveCSS: false
  });

  // ------------------------------------------------------------------
  // MathJax document
  // ------------------------------------------------------------------
  const html = mathjax.document(content, {
    InputJax: mathml,
    OutputJax: chtml,
  });

  // Async render
  await html.renderPromise();

  // ------------------------------------------------------------------
  // Serialize rendered HTML
  // ------------------------------------------------------------------
  let rendered =
    adaptor.doctype(html.document) +
    adaptor.outerHTML(adaptor.root(html.document));

  // ------------------------------------------------------------------
  // Minify MathJax CSS
  // ------------------------------------------------------------------
  const document = new DOMParser().parseFromString(rendered, 'text/html');

  for (const style of document.querySelectorAll('#MJX-CHTML-styles')) {
    
    style.innerHTML = new CleanCSS({ level: 2 }).minify(style.innerHTML.replace(/clip-path:[^;]+;/g, '')).styles;
  }

  return document.toString();
}

